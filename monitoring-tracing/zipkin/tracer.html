<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Tracer · Infilos</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Infilos'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../js/page.js"></script>
<script type="text/javascript" src="../../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../css/page.css"/>

<!--
<link rel="shortcut icon" href="../../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../../index.html" >
<span class="home-icon">⌂</span>Infilos
</a>
<div class="version-number">
1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../vm/index.html" class="page">虚拟机</a>
  <ul>
    <li><a href="../../vm/java-vm/index.html" class="page">Java VM</a></li>
  </ul></li>
  <li><a href="../../java-lang/index.html" class="page">Java Lang</a>
  <ul>
    <li><a href="../../java-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../java-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../java-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../java-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../java-concur/index.html" class="page">Java Concurrency</a>
  <ul>
    <li><a href="../../java-concur/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../scala-lang/index.html" class="page">Scala Lang</a>
  <ul>
    <li><a href="../../scala-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../scala-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../scala-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../scala-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../scala-concur/index.html" class="page">Scala Concurrency</a></li>
  <li><a href="../../monitoring-tracing/index.html" class="page">监控与追踪</a>
  <ul>
    <li><a href="../../monitoring-tracing/google-dapper-essentials.html" class="page">Google Dapper</a></li>
    <li><a href="../../monitoring-tracing/opentracing-spec.html" class="page">OpenTracing</a></li>
    <li><a href="../../monitoring-tracing/zipkin/index.html" class="page">Zipkin</a></li>
    <li><a href="../../monitoring-tracing/pinpoint.html" class="page">Pinpoint</a></li>
  </ul></li>
  <li><a href="../../high-performance/index.html" class="page">高性能编程</a>
  <ul>
    <li><a href="../../high-performance/ipph/index.html" class="page">深入并行编程</a></li>
    <li><a href="../../high-performance/seven-model/index.html" class="page">并发编程模型</a></li>
    <li><a href="../../high-performance/java-thread-model/index.html" class="page">Java 并发模型</a></li>
    <li><a href="../../high-performance/jc-practice/index.html" class="page">Java 并发实践</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../../index.html">Infilos</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../../index.html" >
<span class="home-icon">⌂</span>Infilos
</a>
<div class="version-number">
1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../vm/index.html" class="page">虚拟机</a>
  <ul>
    <li><a href="../../vm/java-vm/index.html" class="page">Java VM</a></li>
  </ul></li>
  <li><a href="../../java-lang/index.html" class="page">Java Lang</a>
  <ul>
    <li><a href="../../java-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../java-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../java-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../java-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../java-concur/index.html" class="page">Java Concurrency</a>
  <ul>
    <li><a href="../../java-concur/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../scala-lang/index.html" class="page">Scala Lang</a>
  <ul>
    <li><a href="../../scala-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../scala-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../scala-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../scala-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../scala-concur/index.html" class="page">Scala Concurrency</a></li>
  <li><a href="../../monitoring-tracing/index.html" class="page">监控与追踪</a>
  <ul>
    <li><a href="../../monitoring-tracing/google-dapper-essentials.html" class="page">Google Dapper</a></li>
    <li><a href="../../monitoring-tracing/opentracing-spec.html" class="page">OpenTracing</a></li>
    <li><a href="../../monitoring-tracing/zipkin/index.html" class="page">Zipkin</a></li>
    <li><a href="../../monitoring-tracing/pinpoint.html" class="page">Pinpoint</a></li>
  </ul></li>
  <li><a href="../../high-performance/index.html" class="page">高性能编程</a>
  <ul>
    <li><a href="../../high-performance/ipph/index.html" class="page">深入并行编程</a></li>
    <li><a href="../../high-performance/seven-model/index.html" class="page">并发编程模型</a></li>
    <li><a href="../../high-performance/java-thread-model/index.html" class="page">Java 并发模型</a></li>
    <li><a href="../../high-performance/jc-practice/index.html" class="page">Java 并发实践</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../../index.html">Infilos</a></li>
  <li><a href="../../monitoring-tracing/index.html">监控与追踪</a></li>
  <li><a href="../../monitoring-tracing/zipkin/index.html">Zipkin</a></li>
  <li>Tracer</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#tracer" name="tracer" class="anchor"><span class="anchor-link"></span></a>Tracer</h1>
<p>Tracer 便是所有追踪操作的入口类，我们可以通过该类来创建 Span。</p>
<h2><a href="#tracer" name="tracer" class="anchor"><span class="anchor-link"></span></a>Tracer</h2>
<p><code>Tracer</code> 内部的字段是在构造 <code>Tracing</code> 时填充的，因此字段类型与 <code>Tracing</code> 类似。围绕这些字段，<code>Tracer</code> 提供了各种方法来构建、组织追踪信息(Span)：</p>
<ol>
  <li>创建新 Span</li>
  <li>创建子 Span</li>
  <li>创建弟 Span</li>
  <li>创建区域性 Span</li>
  <li>连接 Span</li>
  <li>获取当前 Span</li>
</ol>
<p>下面将主要介绍几种创建方式的区别，Span 的具体实现将在 <a href="">Span</a> 一章详细介绍。</p>
<h3><a href="#创建新-span" name="创建新-span" class="anchor"><span class="anchor-link"></span></a>创建新 Span</h3>
<pre class="prettyprint"><code class="language-java">public Span newTrace() {
	return toSpan(newContextBuilder(null, sampler).build());
}
</code></pre>
<p>显式创建一个新的 Span，这意味这创建了一个新的追踪实例，因此这是一个 Root Span。它内部首先会调用 <code>newContextBuilder</code> 创建一个 <code>TraceContext</code> 实例，再调用 <code>toSpan</code> 方法将 <code>TraceContext</code> 转换为一个 Span。</p>
<h4><a href="#newcontextbuilder" name="newcontextbuilder" class="anchor"><span class="anchor-link"></span></a>newContextBuilder</h4>
<pre class="prettyprint"><code class="language-java">TraceContext.Builder newContextBuilder(
	@Nullable TraceContext parent, Sampler sampler) {
    long nextId = nextId();
    if (parent != null) {
      Boolean sampled = parent.sampled();
      if (sampled == null) sampled = sampler.isSampled(parent.traceId());
      return parent.toBuilder() // copies &quot;extra&quot; from the parent
          .spanId(nextId)
          .parentId(parent.spanId())
          .sampled(sampled);
    }
    return TraceContext.newBuilder()
        .sampled(sampler.isSampled(nextId))
        .traceIdHigh(traceId128Bit ? Platform.get().nextTraceIdHigh() : 0L)
        .traceId(nextId)
        .spanId(nextId);
  }
</code></pre>
<p>该方法接收一个可能为空的 <code>TraceContext</code> 作为父 Span 的 <code>TraceContext</code>；接收一个来自 <code>Tracer</code> 的采样器。如果父 <code>Span.TraceContext</code> 为空，则使用新的 Traceid 创建一个新的 TraceContext，这时当前 Span 作为 RootSpan，Spanid 与 Traceid 相同；如果 <code>Span.TraceContext</code> 不为空，则表示基于该父 Span 创建一个子 Span，因此在创建 <code>TraceContext</code> 时使用原 <code>TraceContext</code> 实例生成一个建造器，该建造器继承了原有的 Traceid，并将 Parentid 设置为父 Spanid，Spanid 设置为新生成的 ID。期间基于采样器求值得到当前 Traceid 是否需要采样的标识，并设置给新创建的 <code>TraceContext</code>。</p>
<h3><a href="#创建弟-span" name="创建弟-span" class="anchor"><span class="anchor-link"></span></a>创建弟 Span</h3>
<p>即一个 Span 的兄弟 Span，基于时间概念，仅会创建一个 Span 的弟 Span。主要用于跨进程的追踪信息传播时对 Span 进行关联。</p>
<pre class="prettyprint"><code class="language-java">public Span nextSpan(TraceContextOrSamplingFlags extracted) {
    TraceContext parent = extracted.context();
    if (extracted.samplingFlags() != null) {
      TraceContext implicitParent = currentTraceContext.get();
      if (implicitParent == null) {
        return toSpan(newContextBuilder(null, extracted.samplingFlags())
            .extra(extracted.extra()).build());
      }
      // fall through, with an implicit parent, not an extracted one
      parent = appendExtra(implicitParent, extracted.extra());
    }
    if (parent != null) {
      TraceContext.Builder builder;
      if (extracted.samplingFlags() != null) {
        builder = newContextBuilder(parent, extracted.samplingFlags());
      } else {
        builder = newContextBuilder(parent, sampler);
      }
      return toSpan(builder.build());
    }
    TraceIdContext traceIdContext = extracted.traceIdContext();
    if (extracted.traceIdContext() != null) {
      Boolean sampled = traceIdContext.sampled();
      if (sampled == null) sampled = sampler.isSampled(traceIdContext.traceId());
      return toSpan(TraceContext.newBuilder()
          .sampled(sampled)
          .debug(traceIdContext.debug())
          .traceIdHigh(traceIdContext.traceIdHigh()).traceId(traceIdContext.traceId())
          .spanId(nextId())
          .extra(extracted.extra()).build());
    }
    // TraceContextOrSamplingFlags is a union of 3 types, we&#39;ve checked all three
    throw new AssertionError(&quot;should not reach here&quot;);
  }
</code></pre>
<p>参数类型 <code>TraceContextOrSamplingFlags</code> 实质上是 <code>TraceContext</code>、<code>TraceidContext</code>、<code>SamplingFlag</code> 三者的枚举(仅会包含其中一个)。该类型的实例会在追踪信息通过跨进程传播时创建，其实例的值决定了如何创建一个弟 Span：</p>
<ol>
  <li>如果包含 <code>SamplingFlag</code>，首先尝试获取当前 TraceContext，如果为空则新建 TraceContext 并添加 <code>SamplingFlag</code> 和额外信息；否则则基于当前 TraceContext 构建出一个新的 TraceContext，并合并额外数据。</li>
  <li>如果包含 <code>TraceContext</code>，则直接基于该 <code>TraceContext</code> 合并已有或当前 Tracer 的采样器，生成一个新的 Span。</li>
  <li>如果包含 <code>TraceidContext</code>，则基于其中的 Traceid 构建一个新的子 Span，并集成采样标记和额外数据。</li>
</ol>
<p>可以发现，兄弟 Span 之间的关系在实现中表现为 Traceid 相同，而 Spanid 不同，除此之外没有任何额外的关联信息，不想父子 Span 一样，子 Span 的 Parentid 为父 Span 的 Spanid。</p>
<h3><a href="#创建区域性-span" name="创建区域性-span" class="anchor"><span class="anchor-link"></span></a>创建区域性 Span</h3>
<pre class="prettyprint"><code class="language-java">public SpanInScope withSpanInScope(@Nullable Span span) {
    return new SpanInScope(currentTraceContext
    	.newScope(span != null ? span.context() : null));
  }
</code></pre>
<p>返回值类型 <code>SpanInScope</code> 实质上是对 <code>TraceContext</code> 包装，它实现了 <code>Closable</code> 接口，以便在 <code>try-with-resource</code> 语句中实现 Span 的自动关闭。</p>
<h3><a href="#连接-span" name="连接-span" class="anchor"><span class="anchor-link"></span></a>连接 Span</h3>
<pre class="prettyprint"><code class="language-java">public final Span joinSpan(TraceContext context) {
    if (context == null) throw new NullPointerException(&quot;context == null&quot;);
    if (!supportsJoin) return newChild(context);
    // If we are joining a trace, we are sharing IDs with the caller
    // If the sampled flag was left unset, we need to make the decision here
    if (context.sampled() == null) { // then the caller didn&#39;t contribute data
      context = context.toBuilder().sampled(sampler.isSampled(context.traceId())).build();
    } else if (context.sampled()) { // we are recording and contributing to the same span ID
      recorder.setShared(context);
    }
    return toSpan(context);
  }
</code></pre>
<p>所谓连接，就是使用 RPC 请求中携带的 Traceid 和 Spanid 在服务端创建一个一样的 Span，这样便实现了客户端 Span 与服务端 Span 的连接。可以通过参数来关闭该连接功能，因为一般来说，我们更偏向于在服务端创建一个新的子 Span，以更加直观的构建整个追踪树。</p>
<h3><a href="#获取当前-span" name="获取当前-span" class="anchor"><span class="anchor-link"></span></a>获取当前 Span</h3>
<pre class="prettyprint"><code class="language-java">@Nullable public Span currentSpan() {
    TraceContext currentContext = currentTraceContext.get();
    return currentContext != null ? toSpan(currentContext) : null;
  }
</code></pre>
<p>通过 <code>Tracer</code> 的 <code>currentTraceContext</code> 字段获取当前的 <code>TraceContext</code>，<a href="">Propagation</a> 一章将会详细介绍其实现机制。</p>
<h2><a href="#traceid" name="traceid" class="anchor"><span class="anchor-link"></span></a>Traceid</h2>
<pre class="prettyprint"><code class="language-java">long nextId() {
    long nextId = Platform.get().randomLong();
    while (nextId == 0L) {
      nextId = Platform.get().randomLong();
    }
    return nextId;
  }
</code></pre>
<p>Traceid 的生成是一个基于平台的实现，即 <code>Platform</code>。</p>
<h2><a href="#platform" name="platform" class="anchor"><span class="anchor-link"></span></a>Platform</h2>
<ul>
  <li><code>Platform</code> 中包含了一个默认的、将追踪写入本地日志的 <code>Reporter</code> 实现，在 <a href="">Reporter</a> 一章中将会详细介绍。</li>
  <li><code>endpoint</code> 方法用于生成一个当前主机的 <code>Endpoint</code> 实例，在 Tracing 一章中已经介绍。</li>
  <li><code>clock</code> 方法用于返回一个基于 <code>System.currentTimeMillis</code> 的 <code>Clock</code> 实现。</li>
  <li><code>randomLong</code> 和 <code>nextTraceIdHigh</code> 则是基于平台提供了生成随机数和高位 Traceid 的实现。</li>
</ul>
<h2><a href="#sampler" name="sampler" class="anchor"><span class="anchor-link"></span></a>Sampler</h2>
<p>采样器可以基于一个规则来决定一个追踪实例是否需要被采样，即是否需要被发送给 Zipkin 的收集器。提供了两种默认实现：</p>
<ul>
  <li>Sampler.ALWAYS_SAMPLE，永远需要被采样。</li>
  <li>Sampler.NEVER_SAMPLE，永不采样。</li>
</ul>
<p>以及四种扩展实现：</p>
<ul>
  <li>BoundarySampler，适用于高流量(&gt;100k)采样，对随机 Traceid 进行采样且仅计算一次。</li>
  <li>CountingSampler，适用于低流量(&lt;100k)采样，可以指定一个浮点数作为采样率，如 <code>0.5</code> 则是对 50% 的追踪数据进行采样。</li>
  <li>DeclarativeSampler，基于业务标注的采用。</li>
  <li>ParameterizedSampler，基于有序规则的采样，比如一个用于提取 HTTP 方法的规则。</li>
</ul>
<div class="nav-next">
<p><strong>Next:</strong> <a href="../../monitoring-tracing/zipkin/span.html">Span</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../../monitoring-tracing/zipkin/tracer.html#tracer" class="header">Tracer</a>
  <ul>
    <li><a href="../../monitoring-tracing/zipkin/tracer.html#tracer" class="header">Tracer</a></li>
    <li><a href="../../monitoring-tracing/zipkin/tracer.html#traceid" class="header">Traceid</a></li>
    <li><a href="../../monitoring-tracing/zipkin/tracer.html#platform" class="header">Platform</a></li>
    <li><a href="../../monitoring-tracing/zipkin/tracer.html#sampler" class="header">Sampler</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2018</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../js/magellan.js"></script>

<style type="text/css">@import "../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0', '')});</script>


</html>
