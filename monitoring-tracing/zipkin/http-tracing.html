<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>HTTPTracing · Infilos</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Infilos'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../js/page.js"></script>
<script type="text/javascript" src="../../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../css/page.css"/>

<!--
<link rel="shortcut icon" href="../../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../../index.html" >
<span class="home-icon">⌂</span>Infilos
</a>
<div class="version-number">
1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../java-lang/index.html" class="page">Java Lang</a>
  <ul>
    <li><a href="../../java-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../java-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../java-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../java-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../java-concur/index.html" class="page">Java Concurrency</a>
  <ul>
    <li><a href="../../java-concur/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../scala-lang/index.html" class="page">Scala Lang</a>
  <ul>
    <li><a href="../../scala-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../scala-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../scala-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../scala-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../scala-concur/index.html" class="page">Scala Concurrency</a></li>
  <li><a href="../../monitoring-tracing/index.html" class="page">Monitoring &amp; Tracing</a>
  <ul>
    <li><a href="../../monitoring-tracing/google-dapper-essentials.html" class="page">Google Dapper</a></li>
    <li><a href="../../monitoring-tracing/opentracing-spec.html" class="page">OpenTracing</a></li>
    <li><a href="../../monitoring-tracing/zipkin/index.html" class="page">Zipkin</a></li>
    <li><a href="../../monitoring-tracing/pinpoint.html" class="page">Pinpoint</a></li>
  </ul></li>
  <li><a href="../../high-performance/index.html" class="page">High Performance</a>
  <ul>
    <li><a href="../../high-performance/ipph/index.html" class="page">Parallel Programming</a></li>
    <li><a href="../../high-performance/seven-model/index.html" class="page">Seven Models</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../../index.html">Infilos</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../../index.html" >
<span class="home-icon">⌂</span>Infilos
</a>
<div class="version-number">
1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../java-lang/index.html" class="page">Java Lang</a>
  <ul>
    <li><a href="../../java-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../java-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../java-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../java-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../java-concur/index.html" class="page">Java Concurrency</a>
  <ul>
    <li><a href="../../java-concur/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../scala-lang/index.html" class="page">Scala Lang</a>
  <ul>
    <li><a href="../../scala-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../scala-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../scala-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../scala-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../scala-concur/index.html" class="page">Scala Concurrency</a></li>
  <li><a href="../../monitoring-tracing/index.html" class="page">Monitoring &amp; Tracing</a>
  <ul>
    <li><a href="../../monitoring-tracing/google-dapper-essentials.html" class="page">Google Dapper</a></li>
    <li><a href="../../monitoring-tracing/opentracing-spec.html" class="page">OpenTracing</a></li>
    <li><a href="../../monitoring-tracing/zipkin/index.html" class="page">Zipkin</a></li>
    <li><a href="../../monitoring-tracing/pinpoint.html" class="page">Pinpoint</a></li>
  </ul></li>
  <li><a href="../../high-performance/index.html" class="page">High Performance</a>
  <ul>
    <li><a href="../../high-performance/ipph/index.html" class="page">Parallel Programming</a></li>
    <li><a href="../../high-performance/seven-model/index.html" class="page">Seven Models</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../../index.html">Infilos</a></li>
  <li><a href="../../monitoring-tracing/index.html">Monitoring &amp; Tracing</a></li>
  <li><a href="../../monitoring-tracing/zipkin/index.html">Zipkin</a></li>
  <li>HTTPTracing</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#httptracing" name="httptracing" class="anchor"><span class="anchor-link"></span></a>HTTPTracing</h1>
<p>Brave 对 HTTP 的支持包括两个方面：客户端与服务端。主要是对 Propagation 中远程传播功能的应用，用以集成各种基于 HTTP 协议的客户端、服务端，以提供追踪功能。</p>
<div  align="center">
<img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20180920230101.png" style="display:block;width:90%;" alt="NAME" align=center />
</div>
<h2><a href="#httptracing" name="httptracing" class="anchor"><span class="anchor-link"></span></a>HTTPTracing</h2>
<p><code>HTTPTracing</code> 是作为主入口，提供了一个用来构建追踪器实例的建造器，接收 6 个参数：</p>
<ul>
  <li>serverName：为客户端指定一个目标服务端名称。</li>
  <li>tracing：<code>Tracing</code> 实例对象。</li>
  <li>clientParser：用于设置客户端模式下请求和响应体中的标签以使得客户端 Span 更具意义。</li>
  <li>clientSampler：用于设置客户端模式下所发起请求的采样策略，比如基于 Traceid 还是 URI 路径。</li>
  <li>serverParser：用于设置服务端模式下请求和响应体中的标签以使得服务端 Span 更具意义。</li>
  <li>serverSampler：用于设置客户端模式下所发起所接受到请求的采样策略，比如忽略来自某 URI 的请求。</li>
</ul>
<h2><a href="#httpadapter" name="httpadapter" class="anchor"><span class="anchor-link"></span></a>HttpAdapter</h2>
<p><code>HttpAdapter</code> 是一个抽象类，拥有两个类型参数 <code>Req</code> 和 <code>Resp</code>，分别表示不同 HTTP 实现中的请求和响应类型。该抽象类中提供了一组方法，用于从特定类型的 <code>Req</code> 和 <code>Resp</code> 中获取请求和响应的基本属性，以作为 Span 的 Tag，从能能够更加全面的对 HTTP 协议进行追踪。</p>
<ul>
  <li><code>method(Req request)</code>，从请求体中获取请求方法</li>
  <li><code>path(Req request)</code>，从请求体中获取请求路径</li>
  <li><code>url(Req request)</code>，从请求体中获取请求 URL</li>
  <li><code>requestHeader(Req request, String name)</code>，从请求体中获取指定的请求头</li>
  <li><code>methodFromResponse(Resp resp)</code>，从响应体中获取请求方法</li>
  <li><code>statusCode(Resp response)</code>，从响应体中获取响应状态码</li>
</ul>
<p>通过该抽象类，我们可以为不同的 HTTP 客户端、服务端实现不同的信息提供逻辑，因此 Brave 针对客户端和服务端提供了两个独立的抽象类，并分别为二者添加了一个方法用于提取请求目标服务的 IP、请求源服务的 IP。</p>
<pre class="prettyprint"><code class="language-java">public abstract class HttpClientAdapter&lt;Req, Resp&gt; extends HttpAdapter&lt;Req, Resp&gt; {
  /** Returns true if an IP representing the client was readable. */
  public boolean parseServerAddress(Req req, Endpoint.Builder builder) {
    return false;
  }
}

public abstract class HttpServerAdapter&lt;Req, Resp&gt; extends HttpAdapter&lt;Req, Resp&gt; {
  /**
   * Returns true if an IP representing the client was readable. 
   * Defaults to parse the &quot;X-Forwarded-For&quot; header.
   */
  public boolean parseClientAddress(Req req, Endpoint.Builder builder) {
    String xForwardedFor = requestHeader(req, &quot;X-Forwarded-For&quot;);
    return xForwardedFor != null &amp;&amp; builder.parseIp(xForwardedFor);
  }
}
</code></pre>
<p>在适配不同的 HTTP 客户端和服务端实现时，我们直接实现这两个抽象类即可。</p>
<h2><a href="#httpparser" name="httpparser" class="anchor"><span class="anchor-link"></span></a>HttpParser</h2>
<p>该类用于从 HTTP 请求中提取必要的信息以填充 Span、从 HTTP 响应或异常中提取信息以填充 Span，比如使用请求方法名作为 Span 的 name。主要使用 <code>HttpAdapter</code> 中提供的方法提取必要信息以丰富 Span 中的数据。</p>
<pre class="prettyprint"><code class="language-java">public class HttpParser {
	protected ErrorParser errorParser() {...}
    
    protected &lt;Req&gt; String spanName(HttpAdapter&lt;Req, ?&gt; adapter, Req req) {...}
    
    public &lt;Req&gt; void request(
    	HttpAdapter&lt;Req, ?&gt; adapter, 
    	Req req, SpanCustomizer customizer) {...}
        
    public &lt;Resp&gt; void response(
    	HttpAdapter&lt;?, Resp&gt; adapter, 
    	@Nullable Resp res,
		@Nullable Throwable error, 
        SpanCustomizer customizer) {...}
        
    protected void error(
    	@Nullable Integer httpStatus, 
        @Nullable Throwable error,
        SpanCustomizer customizer) {...}
}
</code></pre>
<ul>
  <li>errorParser，用于获取异常解析器。</li>
  <li>spanName，用于生成 Span 的名称，默认使用 HTTP 方法名。</li>
  <li>request，用于提取请求体中的信息到 Span。</li>
  <li>response，用于提取响应体中的信息到 Span。</li>
  <li>error，使用异常解析器格式化异常信息到 Span，因为服务端要么返回一个响应、要么出现异常。</li>
</ul>
<p>具体到客户端模式和服务端模式则分别提供了两个抽象子类：<code>HttpClientParser</code>、<code>HttpServerParser</code>。</p>
<h2><a href="#httphandler" name="httphandler" class="anchor"><span class="anchor-link"></span></a>HttpHandler</h2>
<p>抽象类 <code>HttpHandler</code> 建模了基于 HTTP 协议进行追踪的过程，即基于具体的请求响应构建 Span、发送 Span。</p>
<pre class="prettyprint"><code class="language-java">abstract class HttpHandler&lt;Req, Resp, A extends HttpAdapter&lt;Req, Resp&gt;&gt; {
	final CurrentTraceContext currentTraceContext;
  	final A adapter;
  	final HttpParser parser;
    
    HttpHandler(
    	CurrentTraceContext currentTraceContext, 
        A adapter, 
        HttpParser parser) {...}

	Span handleStart(Req request, Span span) {...}
    void handleFinish(Resp response, Throwable error, Span span) {...}
}
</code></pre>
<ul>
  <li>handleStart，用于创建 Span，基于请求体、使用 HttpAdapter、HttpParser 向 Span 填充必要的信息。</li>
  <li>handleFinish，用于结束 Span，基于响应体或异常、使用 HttpAdapter、HttpParser 向 Span 填充必要的信息。</li>
</ul>
<p>这是两个具体方法，针对客户端和服务端模式提供的 HttpClientHandler、HttpServerHandler 分别基于两种模式的不同处理方式对上面两个方法提供了不同的过程封装：</p>
<ul>
  <li>HttpClientHandler</li>
  <li>handleSend，发出请求时，调用 handleStart</li>
  <li>handleReceive，接收到响应时，调用 handleFinish</li>
  <li>HttpServerHandler</li>
  <li>handleReceive，接收到请求时，调用 handleStart</li>
  <li>handleSend，返回响应时，调用 handleFinish</li>
</ul>
<h2><a href="#httpsampler" name="httpsampler" class="anchor"><span class="anchor-link"></span></a>HttpSampler</h2>
<p>基于 HTTP 协议的采样器，比如基于请求路径决定该请求是否需要被采样。实现如下方法即可：</p>
<pre class="prettyprint"><code class="language-java">abstract &lt;Req&gt; Boolean trySample(HttpAdapter&lt;Req, ?&gt; adapter, Req request);
</code></pre>
<p>同时提供了两个默认实现：</p>
<ul>
  <li>TRACE_ID，不在基于请求体，而是使用 Traceid 来决定是否采样。</li>
  <li>NEVER_SAMPLE，从不采样。</li>
</ul>
<h3><a href="#httprulesampler" name="httprulesampler" class="anchor"><span class="anchor-link"></span></a>HttpRuleSampler</h3>
<p><code>HttpSampler</code> 的具体子类，可以为不同的采样规则设置不同的采样率。</p>
<pre class="prettyprint"><code class="language-java">HttpRuleSampler.newBuilder()
	.addRule(null, &quot;/foo&quot;, 0.8f)
	.addRule(&quot;POST&quot;, &quot;/bar&quot;, 0.1f)
	.build();
</code></pre>
<h2><a href="#集成" name="集成" class="anchor"><span class="anchor-link"></span></a>集成</h2>
<p>最终，在集成特定 HTTP 实现时：</p>
<ul>
  <li>实现 HttpAdapter 以从具体的 HttpReqeust、HttpResponse 实现类中提取相关信息。</li>
  <li>根据需要，决定是否需要实现 HttpParser 来定制通过 HTTP 信息构造 Span 的逻辑。</li>
  <li>使用默认或实现特定功能的采样器、异常解析器。</li>
  <li>分别创建针对客户端、服务端模式的 HttpClientHandler、HttpServerHandler 实例，再分别集成到对应客户端、服务端模式的 RequestInterceptor、RequestFilter 即可。</li>
</ul>
<div class="nav-next">
<p><strong>Next:</strong> <a href="../../monitoring-tracing/pinpoint.html">Pinpoint</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../../monitoring-tracing/zipkin/http-tracing.html#httptracing" class="header">HTTPTracing</a>
  <ul>
    <li><a href="../../monitoring-tracing/zipkin/http-tracing.html#httptracing" class="header">HTTPTracing</a></li>
    <li><a href="../../monitoring-tracing/zipkin/http-tracing.html#httpadapter" class="header">HttpAdapter</a></li>
    <li><a href="../../monitoring-tracing/zipkin/http-tracing.html#httpparser" class="header">HttpParser</a></li>
    <li><a href="../../monitoring-tracing/zipkin/http-tracing.html#httphandler" class="header">HttpHandler</a></li>
    <li><a href="../../monitoring-tracing/zipkin/http-tracing.html#httpsampler" class="header">HttpSampler</a></li>
    <li><a href="../../monitoring-tracing/zipkin/http-tracing.html#集成" class="header">集成</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2018</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../js/magellan.js"></script>

<style type="text/css">@import "../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0', '')});</script>


</html>
