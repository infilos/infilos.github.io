<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>CH04-并行工具 · Infilos</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Infilos'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../js/page.js"></script>
<script type="text/javascript" src="../../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../css/page.css"/>

<!--
<link rel="shortcut icon" href="../../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../../index.html" >
<span class="home-icon">⌂</span>Infilos
</a>
<div class="version-number">
1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../T001_os/index.html" class="page">操作系统</a>
  <ul>
    <li><a href="../../T001_os/performance-issue/index.html" class="page">^性能之殇</a></li>
  </ul></li>
  <li><a href="../../T002_vm/index.html" class="page">虚拟机</a>
  <ul>
    <li><a href="../../T002_vm/java-vm/index.html" class="page">Java VM</a></li>
  </ul></li>
  <li><a href="../../T003_java-lang/index.html" class="page">Java Lang</a>
  <ul>
    <li><a href="../../T003_java-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../T003_java-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../T003_java-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../T003_java-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../T004_scala-lang/index.html" class="page">Scala Lang</a>
  <ul>
    <li><a href="../../T004_scala-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../T004_scala-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../T004_scala-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../T004_scala-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../T005_concurrency/index.html" class="page">并发编程</a>
  <ul>
    <li><a href="../../T005_concurrency/ipph/index.html" class="page">深入并行编程</a></li>
    <li><a href="../../T005_concurrency/seven-model/index.html" class="page">并发编程模型</a></li>
    <li><a href="../../T005_concurrency/java-thread-model/index.html" class="page">Java 并发模型</a></li>
    <li><a href="../../T005_concurrency/jc-practice/index.html" class="page">Java 并发实践</a></li>
  </ul></li>
  <li><a href="../../T006_networking/index.html" class="page">网络编程</a></li>
  <li><a href="../../T007_monit-tracing/index.html" class="page">监控&amp;追踪</a>
  <ul>
    <li><a href="../../T007_monit-tracing/google-dapper-essentials.html" class="page">Google Dapper</a></li>
    <li><a href="../../T007_monit-tracing/opentracing-spec.html" class="page">OpenTracing</a></li>
    <li><a href="../../T007_monit-tracing/zipkin/index.html" class="page">Zipkin</a></li>
    <li><a href="../../T007_monit-tracing/pinpoint.html" class="page">Pinpoint</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../../index.html">Infilos</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../../index.html" >
<span class="home-icon">⌂</span>Infilos
</a>
<div class="version-number">
1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../T001_os/index.html" class="page">操作系统</a>
  <ul>
    <li><a href="../../T001_os/performance-issue/index.html" class="page">^性能之殇</a></li>
  </ul></li>
  <li><a href="../../T002_vm/index.html" class="page">虚拟机</a>
  <ul>
    <li><a href="../../T002_vm/java-vm/index.html" class="page">Java VM</a></li>
  </ul></li>
  <li><a href="../../T003_java-lang/index.html" class="page">Java Lang</a>
  <ul>
    <li><a href="../../T003_java-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../T003_java-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../T003_java-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../T003_java-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../T004_scala-lang/index.html" class="page">Scala Lang</a>
  <ul>
    <li><a href="../../T004_scala-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../T004_scala-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../T004_scala-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../T004_scala-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../T005_concurrency/index.html" class="page">并发编程</a>
  <ul>
    <li><a href="../../T005_concurrency/ipph/index.html" class="page">深入并行编程</a></li>
    <li><a href="../../T005_concurrency/seven-model/index.html" class="page">并发编程模型</a></li>
    <li><a href="../../T005_concurrency/java-thread-model/index.html" class="page">Java 并发模型</a></li>
    <li><a href="../../T005_concurrency/jc-practice/index.html" class="page">Java 并发实践</a></li>
  </ul></li>
  <li><a href="../../T006_networking/index.html" class="page">网络编程</a></li>
  <li><a href="../../T007_monit-tracing/index.html" class="page">监控&amp;追踪</a>
  <ul>
    <li><a href="../../T007_monit-tracing/google-dapper-essentials.html" class="page">Google Dapper</a></li>
    <li><a href="../../T007_monit-tracing/opentracing-spec.html" class="page">OpenTracing</a></li>
    <li><a href="../../T007_monit-tracing/zipkin/index.html" class="page">Zipkin</a></li>
    <li><a href="../../T007_monit-tracing/pinpoint.html" class="page">Pinpoint</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../../index.html">Infilos</a></li>
  <li><a href="../../T005_concurrency/index.html">并发编程</a></li>
  <li><a href="../../T005_concurrency/ipph/index.html">深入并行编程</a></li>
  <li>CH04-并行工具</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#ch04-并行工具" name="ch04-并行工具" class="anchor"><span class="anchor-link"></span></a>CH04-并行工具</h1>
<p>本章主要介绍一些并行编程领域的基本工具，主要是类 Linux 系统上可以供应用程序使用的工具。</p>
<h2><a href="#脚本语言" name="脚本语言" class="anchor"><span class="anchor-link"></span></a>脚本语言</h2>
<p>Shell 脚本提供了一种简单有效的并行化：</p>
<pre class="prettyprint"><code class="language-bash">1 compute_it 1 &gt; compute_it.1.out &amp; 
2 compute_it 2 &gt; compute_it.2.out &amp; 
3 wait 
4 cat compute_it.1.out
5 cat compute_it.2.out
</code></pre>
<p>第 1、2 行分别启动了两个实例，通过 <code>&amp;</code> 符号使这两个程序在后台运行，并分别将程序的输出重定向到一个文件。第 3 行等待两个实例执行完毕，第 4、5 行显示程序的输出。</p>
<div  align="center">
<img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20180922142852.png" style="display:block;width:50%;" alt="NAME" align=center />
</div>
<p>另外，例如 <code>make</code> 脚本语言提供了一个 <code>-j</code> 选项来指定编译过程中同时执行多少个并行任务，<code>make -j4</code> 则表示同时执行 4 个并行编译过程。</p>
<p>既然基于脚本的并行编程这么简单，为什么还需要其他工具呢？</p>
<h2><a href="#posix-多进程" name="posix-多进程" class="anchor"><span class="anchor-link"></span></a>POSIX 多进程</h2>
<h3><a href="#posix-进程的创建与销毁" name="posix-进程的创建与销毁" class="anchor"><span class="anchor-link"></span></a>POSIX 进程的创建与销毁</h3>
<p>进程通过 <code>fork()</code> 原语创建，通过 <code>kill()</code> 原语销毁，也可以通过 <code>exit()</code> 原语实现自我销毁。执行 <code>fork()</code> 原语的进程被称为新创建进程的父进程，父进程可以功能通过 <code>wait()</code> 原语等待子进程执行完毕。</p>
<pre class="prettyprint"><code class="language-c">1 pid = fork(); 
2 if (pid == 0) { 
3 	/ * child * / 
4 } else if (pid &lt; 0) { 
5 	/ * parent, upon error * / 
6 	perror(&quot;fork&quot;); 
7 	exit(-1); 
8 } else { 
9 	/ * parent, pid == child ID * / 
10 }
</code></pre>
<p><code>fork()</code> 的返回值表示了其执行状态，即上面片段中的 pid。</p>
<pre class="prettyprint"><code class="language-c">1 void waitall(void) 
2 { 
3 	int pid; 
4 	int status; 
5 
6 	for (;;) { 
7 		pid = wait(&amp;status); 
8 		if (pid == -1) { 
9 			if (errno == ECHILD) 
10 			break; 
11 			perror(&quot;wait&quot;); 
12 			exit(-1); 
13 		} 
14 	} 
15 }
</code></pre>
<p>父进程使用 <code>wait()</code> 原语来等待子进程时，<code>wait()</code> 只能等待一个子进程。我们将 <code>wait()</code> 原语封装成一个 <code>waitall()</code> 函数，该函数与 shell 中的 <code>wait</code> 意义一样：<code>for(;;)</code> 将会一直循环，每次循环等待一个子进程，阻塞直到该子进程退出，并返回子进程的进程 ID 号，如果该进程号为 -1，则表示 <code>wait()</code> 无法等待子进程执行完毕。如果检查错误码为 <code>ECHILD</code> 则表示没有其他子进程了，这时退出循环。</p>
<p><code>wait()</code> 原语的复杂性在于，父进程与子进程之间不共享内存，而最细粒度的并行化需要共享内存，这时则要比不共享内存式的并行化复杂很多。</p>
<p>这种 <code>fork-waitall</code> 的形式被称为 <strong>fork-join</strong>。</p>
<h3><a href="#posix-线程创建与销毁" name="posix-线程创建与销毁" class="anchor"><span class="anchor-link"></span></a>POSIX 线程创建与销毁</h3>
<p>在一个已有的进程中创建线程，需要调用 <code>pthread_create()</code> 原语，它的第一个参数指向 <code>pthread_t</code> 类型的指针，第二个 NULL 参数是一个可选的指向 <code>pthread_attr_t</code> 结构的指针，第三个参数是新线程要调用的函数(下面的例子中是 <code>mythread()</code>)，最后一个 NULL 参数是传递给 <code>mythread()</code> 的参数。</p>
<pre class="prettyprint"><code class="language-c">1 int x = 0; 
2 
3 void * mythread(void * arg) 
4 { 
5   x = 1; 
6   printf(&quot;Child process set x=1\n&quot;); 
7   return NULL; 
8 } 
9 
10 int main(int argc, char * argv[]) 
11 { 
12   pthread_t tid; 
13   void * vp; 
14 
15   if (pthread_create(&amp;tid, NULL, 
16 				        mythread, NULL) != 0) { 
17     perror(&quot;pthread_create&quot;); 
18     exit(-1); 
19   } 
20   if (pthread_join(tid, &amp;vp) != 0) { 
21     perror(&quot;pthread_join&quot;); 
22     exit(-1); 
23   } 
24   printf(&quot;Parent process sees x=%d\n&quot;, x); 
25   return 0; 
26 }
</code></pre>
<ul>
  <li>第 7 行中，<code>mythread</code> 直接选择了返回，也可以使用 <code>pthread_exist()</code> 结束。</li>
  <li>第 20 行的 <code>pthread_join()</code> 原语是对 fork-join 中 <code>wait()</code> 的模仿，它一直阻塞到 tid 变量指向的线程返回。线程的返回值要么是传给 <code>pthread_exit()</code> 的返回值，要么是线程调用函数的返回值，这取决于线程退出的方式。</li>
</ul>
<p>上面代码的执行结果为：</p>
<pre><code>Child process set x=1 
Parent process sees x=1
</code></pre>
<p>上面的代码中小心构造了一次只有一个线程为变量赋值的场景。任何一个线程为某变量赋值而另一线程读取变量值的场景，都会产生数据竞争(data-race)。因此我们需要一些手段来安全的并发读取数据，即下面的加锁原语。</p>
<h3><a href="#posix-锁" name="posix-锁" class="anchor"><span class="anchor-link"></span></a>POSIX 锁</h3>
<p>POSIX 规范支持开发者使用 POSIX 锁来避免数据竞争。POSIX 锁包括几个原语，其中最基础的是 <code>pthread_mutex_lock()</code> 和 <code>pthread_mutex_unlock()</code>。这些原语将会操作 <code>pthread_mutex_t</code> 类型的锁。该锁的静态声明和初始化由 <code>PTHREAD_MUTEX_INITIALIZER</code> 完成，或者由 <code>pthread_mutex_init()</code> 来动态分配并初始化。</p>
<p>因为这些加锁、解锁原语是互相排斥的，所以一次只能有一个线程在一个特定的时刻持有一把特定的锁。比如，如果两个线程尝试同时获取一把锁，那么其中一个线程会首先获准持有该锁，另一线程只能等待第一个线程释放该锁。</p>
<h3><a href="#posix-读写锁" name="posix-读写锁" class="anchor"><span class="anchor-link"></span></a>POSIX 读写锁</h3>
<p>POSIX API 提供了一种读写锁，用 <code>pthread_rwlock_t</code> 类型来表示，与 <code>pthread_mutex_t</code> 的初始化方式类似。<code>pthread_rwlock_wrlock()</code> 获取写锁，<code>pthread_rwlock_rdlock()</code> 获取读锁，<code>pthread_rwlock_unlock()</code> 用于释放锁。</p>
<p>读写锁是专门为大多数读的情况设计的。该锁能够提供比互斥锁更多的扩展性，因为互斥锁从定义上已经限制了任意时刻只能有一个线程持有锁，而读写锁运行任意多的线程同时持有读锁。</p>
<div  align="center">
<img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20180922143317.png" style="display:block;width:50%;" alt="读写锁的扩展性" align=center />
</div>
<p>读写锁的可扩展性不甚理想，尤其是临界区较小时。为什么读锁的获取这么慢呢？应该是由于所有想获取读锁的线程都要更新 <code>pthread_rwlock_t</code> 的数据结构，因此一旦 128 个线程同时尝试获取读写锁的读锁时，那么这些线程必须逐个更新读锁中的 <code>pthread_rwlock_t</code> 结构。最幸运的线程几乎立即就获得了读锁，而最倒霉的线程则必须在前 127 的线程完成对该结构的更新后再能获得读锁。而增加 CPU 则会让性能变得更糟。</p>
<p>但是在临界区较大，比如开发者进行高延迟的文件或网络 IO 操纵时，读写锁仍然值得使用。</p>
<h3><a href="#原子操作-gcc-" name="原子操作-gcc-" class="anchor"><span class="anchor-link"></span></a>原子操作(GCC)</h3>
<p>读写锁在临界区最小时开销最大，因此需要其他手段来保护极其短小的临界区。GCC 编译器提供了许多附加的原子操作：</p>
<ul>
  <li>返回参数原值</li>
  <li><code>__sync_fetch_and_sub()</code></li>
  <li><code>__sync_fetch_and_or()</code></li>
  <li><code>__sync_fetch_and_and()</code></li>
  <li><code>__sync_fetch_and_xor()</code></li>
  <li><code>__sync_fetch_and_nand()</code></li>
  <li>返回变量新值</li>
  <li><code>__sync_add_and_fetch()</code></li>
  <li><code>__sync_sub_and_fetch()</code></li>
  <li><code>__sync_or_ and_fetch()</code></li>
  <li><code>__sync_and_and_fetch()</code></li>
  <li><code>__sync_xor_and_fetch()</code></li>
  <li><code>__sync_nand_ and_fetch()</code></li>
</ul>
<p>经典的比较并交换(CAS)是由一对原语 <code>__sync_bool_compare_and_swap()</code> 和 <code>__sync_val_compare_and_swap()</code> 提供的，当变量的原值与指定的参数值相等时，这两个原语会自动将新值写到指定变量。第一个原语在操作成功时返回 1，或在变量原值不等于指定值时返回 0；第二个原语在变量值等于指定的参数值时返回变量的原值，表示操作成功。任何对单一变量进行的原子操作都可以用 CAS 方式实现，上述两个原语是通用的，虽然第一个原语在适用的场景中效率更高。CAS 操作通常作为其他原子操作的基础。</p>
<p><code>__sync_synchronize()</code> 原语是一个内存屏障，它限制编译器和 CPU 对指令乱序执行的优化。有些时候只限制编译器对指令的优化就够了，CPU 的优化可以保留，这时则需要 <code>barrier()</code> 原语。有时只需要让编译器不优化某个内存访问就够了，这时可以使用 <code>ACCESS_ONCE()</code> 原语。后两个原语并非由 GCC 直接提供，可以按如下方式实现：</p>
<pre class="prettyprint"><code class="language-c">#define ACCESS_ONCE(x) (*(volatile typeof(x) *)&amp;(x))
#define barrier() __asm____volatile__(&quot;&quot;: : :&quot;memory&quot;)
</code></pre>
<h2><a href="#posix-的操作的替代选择" name="posix-的操作的替代选择" class="anchor"><span class="anchor-link"></span></a>POSIX 的操作的替代选择</h2>
<p>线程操作、加解锁原语、原子操作的出现早于各种标准委员会，因此这些操作存在多种变体。直接使用汇编实现这些操作也十分常见，不仅因为历史原因，还可以在某些特定场景下获得更好的性能。</p>
<h2><a href="#如何选择" name="如何选择" class="anchor"><span class="anchor-link"></span></a>如何选择</h2>
<p>基于经验法则，应该在能够胜任工作的工具中选择最简单的一个。</p>
<ol>
  <li>尽量保持串行。</li>
  <li>Shell 脚本。</li>
  <li>C 中的 fork-join。</li>
  <li>POSIX 线程库原语。</li>
  <li>第几章将要介绍的原语。</li>
</ol>
<p>除此之外，不要忘记除了共享内存多线程执行之外，还可以选择进程间通信和消息传递。</p>
<div class="nav-next">
<p><strong>Next:</strong> <a href="../../T005_concurrency/ipph/ch05-counting.html">CH05-计数</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../../T005_concurrency/ipph/ch04-tools.html#ch04-并行工具" class="header">CH04-并行工具</a>
  <ul>
    <li><a href="../../T005_concurrency/ipph/ch04-tools.html#脚本语言" class="header">脚本语言</a></li>
    <li><a href="../../T005_concurrency/ipph/ch04-tools.html#posix-多进程" class="header">POSIX 多进程</a></li>
    <li><a href="../../T005_concurrency/ipph/ch04-tools.html#posix-的操作的替代选择" class="header">POSIX 的操作的替代选择</a></li>
    <li><a href="../../T005_concurrency/ipph/ch04-tools.html#如何选择" class="header">如何选择</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2018</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../js/magellan.js"></script>

<style type="text/css">@import "../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0', '')});</script>


</html>
