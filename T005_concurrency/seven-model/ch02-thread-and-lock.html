<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>CH02-线程与锁 · Infilos</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Infilos'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../js/page.js"></script>
<script type="text/javascript" src="../../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../css/page.css"/>

<!--
<link rel="shortcut icon" href="../../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../../index.html" >
<span class="home-icon">⌂</span>Infilos
</a>
<div class="version-number">
1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../T001_os/index.html" class="page">操作系统</a>
  <ul>
    <li><a href="../../T001_os/performance-issue/index.html" class="page">^性能之殇</a></li>
  </ul></li>
  <li><a href="../../T002_vm/index.html" class="page">虚拟机</a>
  <ul>
    <li><a href="../../T002_vm/java-vm/index.html" class="page">Java VM</a></li>
  </ul></li>
  <li><a href="../../T003_java-lang/index.html" class="page">Java Lang</a>
  <ul>
    <li><a href="../../T003_java-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../T003_java-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../T003_java-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../T003_java-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../T004_scala-lang/index.html" class="page">Scala Lang</a>
  <ul>
    <li><a href="../../T004_scala-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../T004_scala-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../T004_scala-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../T004_scala-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../T005_concurrency/index.html" class="page">并发编程</a>
  <ul>
    <li><a href="../../T005_concurrency/ipph/index.html" class="page">深入并行编程</a></li>
    <li><a href="../../T005_concurrency/seven-model/index.html" class="page">并发编程模型</a></li>
    <li><a href="../../T005_concurrency/java-thread-model/index.html" class="page">Java 并发模型</a></li>
    <li><a href="../../T005_concurrency/jc-practice/index.html" class="page">Java 并发实践</a></li>
  </ul></li>
  <li><a href="../../T006_networking/index.html" class="page">网络编程</a></li>
  <li><a href="../../T007_monit-tracing/index.html" class="page">监控&amp;追踪</a>
  <ul>
    <li><a href="../../T007_monit-tracing/google-dapper-essentials.html" class="page">Google Dapper</a></li>
    <li><a href="../../T007_monit-tracing/opentracing-spec.html" class="page">OpenTracing</a></li>
    <li><a href="../../T007_monit-tracing/zipkin/index.html" class="page">Zipkin</a></li>
    <li><a href="../../T007_monit-tracing/pinpoint.html" class="page">Pinpoint</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../../index.html">Infilos</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../../index.html" >
<span class="home-icon">⌂</span>Infilos
</a>
<div class="version-number">
1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../T001_os/index.html" class="page">操作系统</a>
  <ul>
    <li><a href="../../T001_os/performance-issue/index.html" class="page">^性能之殇</a></li>
  </ul></li>
  <li><a href="../../T002_vm/index.html" class="page">虚拟机</a>
  <ul>
    <li><a href="../../T002_vm/java-vm/index.html" class="page">Java VM</a></li>
  </ul></li>
  <li><a href="../../T003_java-lang/index.html" class="page">Java Lang</a>
  <ul>
    <li><a href="../../T003_java-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../T003_java-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../T003_java-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../T003_java-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../T004_scala-lang/index.html" class="page">Scala Lang</a>
  <ul>
    <li><a href="../../T004_scala-lang/basics/index.html" class="page">Basics</a></li>
    <li><a href="../../T004_scala-lang/effects/index.html" class="page">Effectives</a></li>
    <li><a href="../../T004_scala-lang/profess/index.html" class="page">Professionals</a></li>
    <li><a href="../../T004_scala-lang/puzzles/index.html" class="page">Puzzles</a></li>
  </ul></li>
  <li><a href="../../T005_concurrency/index.html" class="page">并发编程</a>
  <ul>
    <li><a href="../../T005_concurrency/ipph/index.html" class="page">深入并行编程</a></li>
    <li><a href="../../T005_concurrency/seven-model/index.html" class="page">并发编程模型</a></li>
    <li><a href="../../T005_concurrency/java-thread-model/index.html" class="page">Java 并发模型</a></li>
    <li><a href="../../T005_concurrency/jc-practice/index.html" class="page">Java 并发实践</a></li>
  </ul></li>
  <li><a href="../../T006_networking/index.html" class="page">网络编程</a></li>
  <li><a href="../../T007_monit-tracing/index.html" class="page">监控&amp;追踪</a>
  <ul>
    <li><a href="../../T007_monit-tracing/google-dapper-essentials.html" class="page">Google Dapper</a></li>
    <li><a href="../../T007_monit-tracing/opentracing-spec.html" class="page">OpenTracing</a></li>
    <li><a href="../../T007_monit-tracing/zipkin/index.html" class="page">Zipkin</a></li>
    <li><a href="../../T007_monit-tracing/pinpoint.html" class="page">Pinpoint</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../../index.html">Infilos</a></li>
  <li><a href="../../T005_concurrency/index.html">并发编程</a></li>
  <li><a href="../../T005_concurrency/seven-model/index.html">并发编程模型</a></li>
  <li>CH02-线程与锁</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#ch02-线程与锁" name="ch02-线程与锁" class="anchor"><span class="anchor-link"></span></a>CH02-线程与锁</h1>
<p>虽然该模型稍显原始且难以驾驭、不够可靠还有点危险，但仍然是并发编程的首选项，也是其他并发模型的基石。</p>
<h2><a href="#对硬件运行过程形式化" name="对硬件运行过程形式化" class="anchor"><span class="anchor-link"></span></a>对硬件运行过程形式化</h2>
<p>该模型其实是对底层硬件运行过程的形式化。这种形式化既是该模型的最大优点、也是其最大的缺点。</p>
<p>该模型非常简单直接，几乎所有编程语言都提供了对该模型的支持，且不对其使用方式加以限制。</p>
<h2><a href="#互斥与内存模型" name="互斥与内存模型" class="anchor"><span class="anchor-link"></span></a>互斥与内存模型</h2>
<p>互斥：使用锁来保证某一时间仅有一个线程可以访问数据。它会带来竟态条件和死锁。</p>
<p>乱序执行的来源：</p>
<ul>
  <li>编译器和静态优化</li>
  <li>JVM 动态优化</li>
  <li>底层硬件优化</li>
</ul>
<p>从直觉上来说，编译器、JVM、硬件都不应该修改原有的代码逻辑，但是近几年的运行效率提升，尤其是共享内存架构的运行效率提升，均基于此类代码的优化。</p>
<p>Java 内存模型为这类优化提供了标准。</p>
<h3><a href="#内存可见性" name="内存可见性" class="anchor"><span class="anchor-link"></span></a>内存可见性</h3>
<p>Java 内存模型定义了一个线程对内存的修改何时对另一个线程可见。基本原则是，如果读线程和写线程不进行同步，就不能保证可见性。</p>
<h3><a href="#多把锁" name="多把锁" class="anchor"><span class="anchor-link"></span></a>多把锁</h3>
<p>很容易得出一个结论：让多线程代码安全运行的方法只能是让所有的代码都同步。但是这么做有两个缺点：</p>
<ul>
  <li>效率低下：如果每个方法都同步，大多数线程会频繁阻塞，也就失去了并发的意义。</li>
  <li>死锁：哲学家就餐问题。</li>
</ul>
<h3><a href="#总结" name="总结" class="anchor"><span class="anchor-link"></span></a>总结</h3>
<ul>
  <li>对共享变量的所有访问都需要同步化。</li>
  <li>读线程、写线程都需要同步化。</li>
  <li>按照约定的全局顺序来获取多把锁。</li>
  <li>当持有锁时避免调用外部方法(无法确保线程安全性)。</li>
  <li>持有锁的时间尽可能的短。</li>
</ul>
<h2><a href="#更多同步机制" name="更多同步机制" class="anchor"><span class="anchor-link"></span></a>更多同步机制</h2>
<h3><a href="#内置锁的限制" name="内置锁的限制" class="anchor"><span class="anchor-link"></span></a>内置锁的限制</h3>
<ul>
  <li>一个线程因为等待内置锁而进入阻塞之后，就无法中断该线程了。</li>
  <li>尝试获得内置锁时无法设置超时。</li>
  <li>必须通过 synchronized 块来获取内置锁。</li>
</ul>
<h3><a href="#可中断的锁" name="可中断的锁" class="anchor"><span class="anchor-link"></span></a>可中断的锁</h3>
<p>ReentrantLock 提供了显式的加解锁方法，可以在代码的不同位置来实现加解锁逻辑，这是 synchronized 块无法做到的。</p>
<p>同时，ReentrantLock 提供的 lockInterruptibly 方法可以用于终止死锁线程。</p>
<h3><a href="#超时设置" name="超时设置" class="anchor"><span class="anchor-link"></span></a>超时设置</h3>
<p>ReentrantLock 还可以为获取锁的超时设置超时时间。</p>
<h3><a href="#交替锁" name="交替锁" class="anchor"><span class="anchor-link"></span></a>交替锁</h3>
<p>设想我们要在链表插入一个节点，一种做法是用锁保护整个链表，但链表加锁时其他使用者无法访问该链表。而交替锁可以做到仅锁住链表的一部分，允许不涉及被锁部分的其他线程继续自由的访问链表。同样可以由 ReentrantLock 实现。</p>
<h3><a href="#条件变量" name="条件变量" class="anchor"><span class="anchor-link"></span></a>条件变量</h3>
<p>并发编程经常需要等待某个事件发生。比如从队列删除元素前需要等待队列非空、向缓存添加数据前需要等待缓存拥有足够的空间。这时就需要条件变量 Condition。</p>
<p>一个条件变量需要与一把锁关联，线程在开始等待条件之前必须先获取这把锁。获取锁后，线程检查所有等待的条件是否为真。如果条件为真，线程将解锁并继续执行。</p>
<p>如果条件不为真，线程会调优 await 方法，它将原子的解锁并阻塞等待该条件。</p>
<p>当另一个线程调用了 signal 或 signalAll，意味着对应的条件可能已变为真，await 方法将原子的恢复运行并重新加锁。</p>
<h3><a href="#原子变量" name="原子变量" class="anchor"><span class="anchor-link"></span></a>原子变量</h3>
<p>比如 AtomicInteger。与锁相比，原子变量有很多好处。首先，我们不会忘记在正确的时候获取锁；其次，由于没有锁的参与，对原子变量的操作不会引发死锁；最后，原子变量是无锁(lock-free)非阻塞(non-blocking)算法的基础，这种算法可以不使用锁和阻塞来达到同步的目的。</p>
<p>无锁代码比起有锁代码更加复杂，JUC 中的类都尽量使用了无锁代码。</p>
<h3><a href="#总结" name="总结" class="anchor"><span class="anchor-link"></span></a>总结</h3>
<p>ReentrantLock 和 JUC.atomic 突破了使用内置锁的限制，可以利用它们做到：</p>
<ol>
  <li>在线程获取锁时将其中断。</li>
  <li>设置线程获取锁时的超时时间。</li>
  <li>按任意顺序获取和释放锁。</li>
  <li>用条件变量来等待某个条件变为真。</li>
  <li>使用原子变量来避免使用锁。</li>
</ol>
<h2><a href="#利用已有工具" name="利用已有工具" class="anchor"><span class="anchor-link"></span></a>利用已有工具</h2>
<h3><a href="#线程池" name="线程池" class="anchor"><span class="anchor-link"></span></a>线程池</h3>
<p>比如，编写服务端应用时为每个连接请求创建一个线程，这样存在两个隐患：</p>
<ol>
  <li>创建线程是有代价的。</li>
  <li>连接数的增长会使得线程数不断增长，而系统资源(如内存)是有限的。</li>
</ol>
<p>可以使用线程池来对线程进行复用，JUC 提供了各种类型的线程池。</p>
<h3><a href="#写时复制" name="写时复制" class="anchor"><span class="anchor-link"></span></a>写时复制</h3>
<p>比如 CopyOnWriteArrayList，它使用了保护性复制策略。它并非在遍历链表前进行复制，而是在链表被修改时复制，已经投入使用的迭代器会使用当时的旧副本。</p>
<h3><a href="#其他概念" name="其他概念" class="anchor"><span class="anchor-link"></span></a>其他概念</h3>
<ul>
  <li>使用线程构建“生产者——消费者模型”。</li>
  <li>毒丸(Poison Pill) 是一个特殊对象，告诉消费者“数据已取完，你可以退出了”。</li>
  <li>使用线程构建“单生产者——多消费者模型”。</li>
  <li>使用并发集合汇总多个消费者并发生成的结果。</li>
  <li>使用线程池来优化线程的使用。</li>
  <li>使用 ConcurrentHashMap 的分段锁优势，避免过多线程对单个资源的过度竞争。</li>
  <li>为各个消费者提供各自的结构缓存，最后再汇总这些缓存，以避免没有必要的数据竞争。</li>
</ul>
<h3><a href="#总结" name="总结" class="anchor"><span class="anchor-link"></span></a>总结</h3>
<ul>
  <li>使用线程池，而不是直接创建线程。</li>
  <li>使用写时复制让监听器先关的代码更简单高效。</li>
  <li>使用同步队列构建生产者消费者模型。</li>
  <li>ConcurrentHashMap 提供了更好的并发访问。</li>
</ul>
<h2><a href="#本章总结" name="本章总结" class="anchor"><span class="anchor-link"></span></a>本章总结</h2>
<h3><a href="#优点" name="优点" class="anchor"><span class="anchor-link"></span></a>优点</h3>
<ul>
  <li>适用面广，是许多其他技术的基础，更加接近于本质——近似对硬件工作方式的形式化，真确应用可以得到很高的效率。能够解决从小达到不同粒度的问题。</li>
  <li>该模型可以被集成到大多数编程语言中。语言设计者可以轻易让一门指令式语言或 OO 语言支持该模型。</li>
</ul>
<h3><a href="#缺点" name="缺点" class="anchor"><span class="anchor-link"></span></a>缺点</h3>
<ul>
  <li>该模型没有为并行提供直接的支持。</li>
  <li>该模型仅支持共享内存模型。如果要支持分布式内存模型则需要借助其他工具。</li>
  <li>最大的缺点在于“无助”，应用开发者在编程语言层面没有得到足够的帮助。</li>
</ul>
<h3><a href="#隐性错误" name="隐性错误" class="anchor"><span class="anchor-link"></span></a>隐性错误</h3>
<p>应用多线程的难点不在编程，而在于难以测试。而测试中的一个大问题是难以复现。</p>
<p>随着项目的迭代和时间的流式，复杂的多线程代码会变得难以维护。</p>
<div class="nav-next">
<p><strong>Next:</strong> <a href="../../T005_concurrency/seven-model/ch03-functional.html">CH03-函数式编程</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../../T005_concurrency/seven-model/ch02-thread-and-lock.html#ch02-线程与锁" class="header">CH02-线程与锁</a>
  <ul>
    <li><a href="../../T005_concurrency/seven-model/ch02-thread-and-lock.html#对硬件运行过程形式化" class="header">对硬件运行过程形式化</a></li>
    <li><a href="../../T005_concurrency/seven-model/ch02-thread-and-lock.html#互斥与内存模型" class="header">互斥与内存模型</a></li>
    <li><a href="../../T005_concurrency/seven-model/ch02-thread-and-lock.html#更多同步机制" class="header">更多同步机制</a></li>
    <li><a href="../../T005_concurrency/seven-model/ch02-thread-and-lock.html#利用已有工具" class="header">利用已有工具</a></li>
    <li><a href="../../T005_concurrency/seven-model/ch02-thread-and-lock.html#本章总结" class="header">本章总结</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2018</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../js/magellan.js"></script>

<style type="text/css">@import "../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0', '')});</script>


</html>
